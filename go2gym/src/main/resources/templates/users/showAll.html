<!doctype html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <title>GoGym Member Portal</title>

    <link rel="stylesheet" href="/css/go2gym.css">
    <link rel="stylesheet" href="/css/dashboard.css">

    <!--API API API API API API API API-->
    <!--API API API API API API API API-->
    <!--MIXPANEL API-->
    <!-- Paste this right before your closing </head> tag -->
    <script type="text/javascript">
        (function (f, b) { if (!b.__SV) { var e, g, i, h; window.mixpanel = b; b._i = []; b.init = function (e, f, c) { function g(a, d) { var b = d.split("."); 2 == b.length && ((a = a[b[0]]), (d = b[1])); a[d] = function () { a.push([d].concat(Array.prototype.slice.call(arguments, 0))); }; } var a = b; "undefined" !== typeof c ? (a = b[c] = []) : (c = "mixpanel"); a.people = a.people || []; a.toString = function (a) { var d = "mixpanel"; "mixpanel" !== c && (d += "." + c); a || (d += " (stub)"); return d; }; a.people.toString = function () { return a.toString(1) + ".people (stub)"; }; i = "disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking start_batch_senders people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split( " "); for (h = 0; h < i.length; h++) g(a, i[h]); var j = "set set_once union unset remove delete".split(" "); a.get_group = function () { function b(c) { d[c] = function () { call2_args = arguments; call2 = [c].concat(Array.prototype.slice.call(call2_args, 0)); a.push([e, call2]); }; } for ( var d = {}, e = ["get_group"].concat( Array.prototype.slice.call(arguments, 0)), c = 0; c < j.length; c++) b(j[c]); return d; }; b._i.push([e, f, c]); }; b.__SV = 1.2; e = f.createElement("script"); e.type = "text/javascript"; e.async = !0; e.src = "undefined" !== typeof MIXPANEL_CUSTOM_LIB_URL ? MIXPANEL_CUSTOM_LIB_URL : "file:" === f.location.protocol && "//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//) ? "https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js" : "//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js"; g = f.getElementsByTagName("script")[0]; g.parentNode.insertBefore(e, g); } })(document, window.mixpanel || []);
    </script>
    
    <script type="text/javascript">
        // Initialize Mixpanel
        mixpanel.init('2348bedec25deadd5f193df97cef31d6', {debug: true, track_pageview: true, persistence: 'localStorage'});
        
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('change', function(event) {
                if (event.target.matches('.role-switch')) {
                    const userId = event.target.getAttribute('data-user-id');
                    const isCheckedIn = event.target.checked;
                    const url = `/users/updateRole?userId=${userId}&role=${isCheckedIn}`;
            
                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        credentials: 'same-origin'
                    })
                    .then(response => {
                        if (response.ok) {
                            alert('Check-in status updated successfully');

                            // Identify the user for Mixpanel
                            mixpanel.identify(userId);
                            
                            // Track the event
                            const eventAction = isCheckedIn ? 'Check-In' : 'Check-Out';
                            mixpanel.track(eventAction, {
                                'User ID': userId,
                                'Event': `Gym ${eventAction}`
                            });

                        } else {
                            alert('Failed to update check-in status');
                            console.error('Failed to update', response);
                        }
                    })
                    .catch(error => console.error('Error:', error));
                }
            });
        });
    </script>

    <style>
        .crowd-meter-container {
            display:contents;
            align-items: center;
            margin: 20px 0;
        }
        .crowd-meter-bar {
            width: 20px;
            height: 50px;
            margin-right: 4px;
            background-color: #fff; /* White color for an unfilled bar */
            border: 1px solid #000; /* Black border for visibility */
        }
        .crowd-meter-bar-filled {
            background-color: #ff0000; /* Red color for a filled bar */
        }
    </style>

</head>

<body> <!-- partial:index.partial.html -->

    <section> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span>
        <!-- <form action="/users/login" method="post"> -->
            <div class="signin">
                <div class="content">
                    <h2>
                        Welcome 
                        <label th:text="${user.name}">Member Name</label>
                    </h2>
                    <!-- <div class="center-panel"> -->
                        <!-- check in switch -->
                            <div class="members-check-in">
                                <h2>Check-In Status</h2>
                                <!-- Single check-in switch for the logged-in member -->
                                <div>
                                    <label class="switch2">
                                        <input type="checkbox" th:checked="${user.role}" th:attr="data-user-id=${user.id}" class="role-switch">
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                            </div>

                        <!-- Crowd Meter Section -->
                        <div class="crowd-meter-container">
                            <h3>Crowd Meter:</h3>
                            <div id="crowdMeter">
                                <div class="crowd-meter-bar"></div>
                                <div class="crowd-meter-bar"></div>
                                <div class="crowd-meter-bar"></div>
                                <div class="crowd-meter-bar"></div>
                                <div class="crowd-meter-bar"></div>
                                <div class="crowd-meter-bar"></div>
                                <div class="crowd-meter-bar"></div>
                            </div>
                        </div>

                        <br>
                        <div class="d-flex justify-content-center">
                            <!-- Corrected anchor tag for redirection -->
                            <a href="/users/crowdhistory" class="btn btn-success btn-lg">Crowd History</a>
                        </div> 
                        <br>
                        <div class="inputBox"> 
                            <a href="/logout">Log out</a>
                        </div>                  
                    <!-- </div> -->
                </div>
            </div>
        <!-- </form> -->
    </section> <!-- partial -->

    <script>
        // Function to update the crowd meter bars
        function updateCrowdMeter(checkedInCount) {
            console.log("Updating crowd meter with count: ", checkedInCount); // For debugging
            var barsToFill = Math.floor(checkedInCount / 4);
            var bars = document.querySelectorAll('.crowd-meter-bar');
            var totalBars = bars.length;

            // Reset all bars to unfilled state
            bars.forEach(bar => {
                bar.classList.remove('crowd-meter-bar-filled');
            });

            // Fill the bars from the end according to the number of checked-in users
            bars.forEach((bar, index) => {
                if (index >= totalBars - barsToFill) {
                    bar.classList.add('crowd-meter-bar-filled');
                }
            });
        }
        
        // Fetch the actual count of checked-in users from the server when the page loads
        document.addEventListener("DOMContentLoaded", function() {
            fetch('/users/checkedInCount')
                .then(response => response.json()) // Parse the JSON response
                .then(checkedInCount => {
                    updateCrowdMeter(checkedInCount);
                })
                .catch(error => console.error('Error fetching checked-in count:', error));
        });
    </script>
    
</body>
</html>

